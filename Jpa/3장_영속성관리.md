# 영속성 관리

jpa가 제공하는 기능은 크게 엔티티와 테이블을 매핑하는 설계부분과 매핑한 엔티티를 실제 사용하는 부분으로 나눌수 있다 . 

이장에서는 매핑한 엔티티를 엔티티 매니저를 통해 어떻게 사용하는지 알아보자.

엔티티 매니저는 엔티티를 저장하고 , 수정하고 , 삭제하고 , 조회하는 등 엔티티와 관련된 모든일을 처리한다.개발자 입장에서 엔티티 매니저는 엔티티를 저장하는 가상의 데이터베이스로 생각하면된다.

## 엔티티 매니저 팩토리와 엔티티 매니저 

데이터 베이스를 하나만 사용하는 애플리케이션은 일반적으로 EntitymanagerFactory를 하나만 생성한다 . 다음은 엔티티 매니저 팩토리를 생성하는 코드다.

`EntityManagerFactory emf = Persistence.createEntityManagerFactory("jpabook");`  공장만들기 , 비용이 아주 많이든다.

이제부터 필요할 때마다 엔티티 매니저 팩토리에서 엔티티 매니저를 생성하면된다.

`EntityManager em = emf.createEntityManager();`  공장에서 엔티티 매니저 생성 , 비용이 거의 안든다.

엔티티 매니저 팩토리를 이름 그대로 엔티티 매니저를 만드는 공장인데 , 공장을 만드는 공장을 만드는 비용은 상당히 크다 . 따라서 한개만 만들어서 애플리케이션 전체에서 공유하도록 설계되어 있다. 

반면에 공장에서 엔티티 매니저를 생성하는 비용은 거의 들지 않는다. **그리고 엔티티 매니저 팩토리는 여러 스레드가 동시에 접근해도 안전하므로 , 서로 다른 스레드 간의 공유해도 되지만 , 엔티티 매니저는 여러 스레드가 동시에 접근하면 동시성 문제가 발생하므로 스레드 간에 절대 공유하면 안된다.**

엔티티 매니저는 데이터베이스 연결이 꼭 필요한 시점까지 커넥션을 얻지 않고, 트랜잭션을 커넥션을 획득한다. 

### 영속성 컨텍스트란 ?

영속성 컨텍스트란 엔티티를 영구 저장하는 환경이라는 뜻이다. 엔티티매니저로 엔티티를 저장하거나 조회하면 엔티티 매니저는 영속성 컨텍스트에 엔티티를 보관하고 관리한다.

`em.persist(member);` 지금까지 이 코드를 단순히 회원 엔티티를 저장한다고 표현했지만 정확히 이야기하면 persist() 메소드는 엔티티 매니저를 사용해서 회원 엔티티를 영속성 컨텍스트에 저장한다.

영속성 컨텍스트는 엔티티 매니저를 생성할 때나 하나 만들어진다 . 그리고 엔티티 매니저를 통해서 영속성 컨텍스트에 접근할 수있고 , 영속성 컨텍스트를 관리할수있다.

## 엔티티의 생명주기

- 비영속 - 영속성 컨텍스트와 전혀 관계가 없는상태
- 영속 - 영속성 컨텍스트에 저장된 상태
- 준영속 - 영속성 컨텍스트에 있다가 저장되었다가 분리된 상태
- 삭제 -  삭제된 상태

### 비영속 

엔티티 객체를 생성했다 . **순수한 객체 상태이며 아직 저장하지 않았다.** 따라서 영속성 컨텍스트나 데이터 베이스와는 전혀 관련이 없다 . 이것을 비영속 상태라고한다. 

ex ) setMemberId("member1");

### 영속

엔티티 매니저를 통해서 엔티티 영속성 컨텍스트에 저장했다 . 이렇게 영속성 컨텍스트가 관리하는 엔티티를 영속 상태라고 한다  . 이제 회원 엔티티는 비영속 상태에서 영속 상태가 되었다.

ex ) em.persist(member); 

### 준영속

영속성 컨텍스트가 관리하던 영속 상태의 엔티티를 영속성 컨텍스트가 관리하지 않으면 준영속 상태가 된다. 특정 엔티티를 준영속 상태로 만들려면 `em.detach()` 를 호출하면된다 . `em.close()`를 호출해서 영속성 컨텍스트를 닫거나 `em.clear()` 를 호출해서 영속성 컨텍스트를 초기화해도 영속성 컨텍스트가 관리하던 영속 상태의 엔티티는 준영속 상태가된다.

### 삭제

엔티티를 영속성 컨텍스트와 데이터 베이스에서 삭제한다.

ex ) em.remove(meber);

## 영속성 컨텍스트의 특징

